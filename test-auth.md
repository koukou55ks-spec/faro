# 認証システムテスト手順

## 🔧 修正内容

### 1. コードベースのクリーンアップ
- ✅ 重複したSupabaseクライアント (`lib/supabase-client.ts`) を削除
- ✅ 使われていないAuth APIルート (`/api/auth/signin`, `/api/auth/signup`) を削除
- ✅ `window.location.href` を `router.push()` に変更（スムーズな遷移）
- ✅ 環境変数テンプレートから実際のプロジェクトIDを除去

### 2. 認証フローの改善
- ✅ ログイン後のリターンURL処理を追加
- ✅ AuthGuardコンポーネントを作成（認証保護）
- ✅ Suspenseを使った適切なローディング処理
- ✅ セッション管理の改善

### 3. データベーススキーマの統一
- ✅ 古い`profiles`テーブルを削除するマイグレーション作成
- ✅ `user_profiles`テーブルを使用するよう統一

## 🧪 テスト手順

### ステップ1: 環境準備

```bash
# 1. プロジェクトディレクトリに移動
cd /c/Users/kouko/OneDrive/ドキュメント/Taxhack

# 2. 依存関係を再インストール（クリーンインストール）
rm -rf node_modules apps/web/node_modules
pnpm install

# 3. キャッシュをクリア
rm -rf apps/web/.next apps/web/.turbo
```

### ステップ2: 環境変数の確認

```bash
# 開発サーバーを起動
pnpm dev

# 別のターミナルで環境変数の状態を確認
curl http://localhost:3000/api/debug-env
```

期待される結果：
```json
{
  "NODE_ENV": "development",
  "NEXT_PUBLIC_SUPABASE_URL": "✅ Set",
  "NEXT_PUBLIC_SUPABASE_ANON_KEY": "✅ Set",
  "SUPABASE_SERVICE_KEY": "✅ Set",
  "supabaseUrlValid": "✅ Valid format",
  "anonKeyLength": 200以上の数値
}
```

### ステップ3: ブラウザテスト

#### A. 新規登録テスト

1. ブラウザのクッキーをクリア
   - F12でDevToolsを開く
   - Application → Storage → Clear site data

2. http://localhost:3000/signup にアクセス

3. 新規アカウントで登録：
   - Email: test@example.com
   - Password: Test123456
   - Password確認: Test123456

4. 確認事項：
   - ✅ 登録後、自動的にトップページにリダイレクト
   - ✅ コンソールにエラーなし
   - ✅ セッションが維持される

#### B. ログアウト→ログインテスト

1. ログアウト（サイドバーのログアウトボタン）

2. http://localhost:3000/login にアクセス

3. 先ほど作成したアカウントでログイン

4. 確認事項：
   - ✅ ログイン成功
   - ✅ トップページにリダイレクト
   - ✅ ユーザー情報が表示される

#### C. 保護されたページのテスト

1. ログアウトした状態で http://localhost:3000/mypage にアクセス

2. 確認事項：
   - ✅ 「ログインが必要です」が表示される
   - ✅ ログインページへの誘導がある

3. ログインして再度 /mypage にアクセス

4. 確認事項：
   - ✅ マイページが正常に表示される
   - ✅ ユーザー情報が表示される

### ステップ4: セッション永続性テスト

1. ログインした状態でブラウザをリロード（F5）

2. 確認事項：
   - ✅ ログイン状態が維持される
   - ✅ ユーザー情報が正しく表示される

3. 開発サーバーを再起動

4. ブラウザをリロード

5. 確認事項：
   - ✅ ログイン状態が維持される

## 🎯 チェックリスト

### 基本機能
- [ ] 新規登録が正常に動作する
- [ ] ログインが正常に動作する
- [ ] ログアウトが正常に動作する
- [ ] セッションが永続化される
- [ ] ページリロード後もログイン状態が維持される

### エラーハンドリング
- [ ] 間違ったパスワードでエラーメッセージが表示される
- [ ] 既存のメールアドレスで登録しようとするとエラーが表示される
- [ ] ネットワークエラー時に適切なメッセージが表示される

### UI/UX
- [ ] ローディング中にスピナーが表示される
- [ ] エラーメッセージが適切に表示される
- [ ] ページ遷移がスムーズ（ちらつきなし）
- [ ] モバイルレスポンシブが正しく動作する

### セキュリティ
- [ ] パスワードが6文字未満の場合エラーになる
- [ ] 環境変数が正しく読み込まれている
- [ ] SERVICE_KEYがクライアントに露出していない

## 📝 トラブルシューティング

### 問題: ログインしても画面が更新されない
**解決策:**
```bash
# キャッシュをクリア
rm -rf apps/web/.next
pnpm dev
```

### 問題: 環境変数が読み込まれない
**解決策:**
1. `.env.local`ファイルが存在することを確認
2. 環境変数の名前が正しいことを確認（`NEXT_PUBLIC_`プレフィックス）
3. 開発サーバーを再起動

### 問題: Supabaseエラーが出る
**解決策:**
1. Supabase Dashboardでプロジェクトが稼働していることを確認
2. APIキーが正しいことを確認
3. ネットワーク接続を確認

## 🚀 本番デプロイ前のチェック

1. **環境変数をVercelに設定**
   - Vercel Dashboard → Settings → Environment Variables
   - 本番用のキーを設定

2. **データベースマイグレーション**
   ```bash
   supabase db push
   ```

3. **ビルドテスト**
   ```bash
   pnpm build
   pnpm start
   ```

4. **型チェック**
   ```bash
   pnpm type-check
   ```

5. **Lintチェック**
   ```bash
   pnpm lint
   ```

## ✅ 完了

すべてのテストが成功したら、認証システムは正常に動作しています！

---

最終更新: 2024年10月24日