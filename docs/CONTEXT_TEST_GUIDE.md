# AIコンテキスト機能 テストガイド

## テスト目的
ノートに保存した情報を、AIチャットが理解して回答に反映できることを確認する。

## 前提条件
✅ データベースマイグレーション完了
✅ 開発サーバー起動中 (http://localhost:3000)
✅ ブラウザのデベロッパーツールを開く (F12)

## テストシナリオ1: 医療費控除

### 1. ノートを作成
1. サイドバーから「すべてのノート」をクリック
2. 「新規ノート」をクリック
3. 以下の内容で保存:

```
タイトル: 2024年の医療費控除
内容:
今年の医療費は合計で約15万円かかりました。
内訳：
- 歯科治療: 8万円
- 眼科: 3万円
- 整形外科: 4万円

確定申告で医療費控除を申請する予定です。
```

### 2. コンソールで確認
ノートを保存した後、ブラウザのコンソールに以下のようなログが出ることを確認:

```
[Notes API] Note created with embedding: {
  noteId: "...",
  hasEmbedding: true,
  embeddingDimensions: 768
}
```

### 3. チャットで質問
チャットに戻って、以下の質問を入力:

```
今年の医療費控除について教えてください
```

### 4. コンソールでコンテキスト確認
コンソールに以下のようなログが出ることを確認:

```
[SupabaseContextService] Context retrieved: {
  query: "今年の医療費控除について教えてください",
  notesCount: 1,
  messagesCount: 0
}
```

### 5. AI回答の確認
AIの回答に以下の要素が含まれていることを確認:
- ✅ 「15万円」という金額に言及
- ✅ 歯科、眼科、整形外科などの具体的な内訳に触れる
- ✅ 一般的な説明だけでなく、ユーザーの状況に合わせた回答

### 期待される回答例
```
あなたの2024年の医療費は合計約15万円（歯科8万円、眼科3万円、整形外科4万円）
ですね。医療費控除を受けるには...
```

## テストシナリオ2: 複数ノートからのコンテキスト

### 1. 追加ノートを作成

**ノート2:**
```
タイトル: 住宅ローン控除
内容:
2024年に新築マンションを購入しました。
借入金額: 3,500万円
金利: 0.5%
返済期間: 35年

住宅ローン控除の申請を考えています。
```

**ノート3:**
```
タイトル: ふるさと納税
内容:
今年のふるさと納税は合計8万円実施。
寄付先:
- 北海道: 3万円
- 熊本県: 5万円

ワンストップ特例を利用予定。
```

### 2. 複合的な質問
```
今年の確定申告で節税できる方法を教えてください
```

### 3. コンテキスト確認
コンソールで複数のノートが検索されていることを確認:

```
[SupabaseContextService] Context retrieved: {
  query: "今年の確定申告で節税できる方法を教えてください",
  notesCount: 3,  ← 3つのノートが見つかった
  messagesCount: 0
}
```

### 4. AI回答の確認
AIの回答に3つのノートすべての内容が反映されていることを確認:
- ✅ 医療費控除（15万円）に言及
- ✅ 住宅ローン控除（3,500万円）に言及
- ✅ ふるさと納税（8万円）に言及

## テストシナリオ3: 関連性の低い質問

### 1. 無関係な質問
```
天気はどうですか？
```

### 2. コンテキスト確認
コンソールでノートが検索されないことを確認:

```
[SupabaseContextService] Context retrieved: {
  query: "天気はどうですか？",
  notesCount: 0,  ← 関連ノートなし
  messagesCount: 0
}
```

### 3. AI回答の確認
一般的な回答になることを確認（ノートの内容は含まれない）

## トラブルシューティング

### エラー1: `hasEmbedding: false`
**原因**: GEMINI_API_KEYが設定されていない
**解決**:
1. `.env.local`を確認
2. `GEMINI_API_KEY=...` を追加
3. 開発サーバーを再起動

### エラー2: `notesCount: 0` (関連する質問なのに)
**原因**: ノートにembeddingが保存されていない
**解決**:
1. ノートを削除して再作成
2. コンソールで `hasEmbedding: true` を確認

### エラー3: `match_notes is not a function`
**原因**: データベースマイグレーションが未実行
**解決**:
```bash
cd "C:\Users\kouko\OneDrive\ドキュメント\Taxhack"
supabase db push
```

### エラー4: AIの回答にノート内容が含まれない
**原因**: コンテキストサービスが注入されていない可能性
**解決**:
1. `apps/web/app/api/chat/route.ts`を確認
2. `SupabaseContextService`が初期化されているか確認
3. 開発サーバーを再起動

## 成功の確認チェックリスト

### データベース
- [ ] `notes.embedding`カラムが存在する
- [ ] `match_notes()`関数が存在する
- [ ] `idx_notes_embedding`インデックスが存在する

### API
- [ ] ノート保存時に`hasEmbedding: true`が表示される
- [ ] embeddingDimensionsが768である
- [ ] チャット時に`Context retrieved`ログが表示される

### AI回答
- [ ] 関連する質問に対してノート内容が反映される
- [ ] 具体的な数値（金額など）が正確に引用される
- [ ] 複数ノートの情報が統合されて回答される
- [ ] 無関係な質問には一般的な回答になる

## パフォーマンス確認

### レスポンス時間
- **ノート保存**: ~500ms以内（embedding生成含む）
- **チャット応答**: ~2秒以内（context検索 + AI生成）

### コンソールタイミング確認
```
1. [Notes API] Note created with embedding... (保存完了)
2. [SupabaseContextService] Context retrieved... (検索完了)
3. AI回答表示
```

すべて正常に動作していれば、**Faroの「Context is everything」が実装完了**です！

## 次のステップ

テストが成功したら:
1. 実際のユースケースでテスト（自分の財務データで試す）
2. 取引履歴のベクトル化を実装（家計簿機能ができたら）
3. パフォーマンス最適化（必要に応じて）
